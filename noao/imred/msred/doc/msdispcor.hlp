.help msdispcor Mar89 noao.msred
.ih
NAME
msdispcor -- Dispersion correct to linear wavelength coordinates
.ih
USAGE
msdispcor input output
.ih
PARAMETERS
.ls input
List of input multispec format spectra to be dispersion corrected.
.le
.ls output
List of dispersion corrected output spectra or root names.
The output spectra image format depends on the \fIformat\fR parameter.
For "onedspec" format the output name is used as a root name with the
aperture number appended as a four digit extension (a format
supported by the \fBonedspec\fR package).  Otherwise the output name
is used without extension and the format will be either "multispec"
format or a single one dimensional spectrum.  If no output list is
specified then the output spectrum will replace the input spectrum after
dispersion correction.
.le
.ls format = "multispec"
The output spectrum format selected from the following list:
.ls "multispec"
The same format as the input spectrum.  The length of the image lines
will be the maximum of longest corrected aperture.
.le
.ls "onedspec"
Each aperture is corrected and written to a separate image with the same
root name and an aperture number extension.  The header format is
compatible with the standard \fBonedspec\fR package format.
.le
.ls "sum", "average", "maximum"
The apertures are corrected to a common dispersion and combined into a single
one dimensional spectrum with the "onedspec" header format but with
no numeric extension.  If the apertures overlap they are combined by
summing, averaging, or selecting the maximum intensity.  If they do
not overlap then zero is recorded for missing wavelengths.
.le
.le
.ls database = "database"
Database containing dispersion solutions created by \fBidentify\fR.
.le
.ls table = ""
Wavelength coordinate table.  Elements in this optional table override
the wavelength coordinates given below for specified apertures.
See the DISCUSSION for additional information.
.le
.ls w1 = INDEF, w2 = INDEF, dw = INDEF, nw = INDEF
The starting wavelength, ending wavelength, wavelength interval per
pixel, and the number of pixels in the output spectra.  Any combination
of these parameters may be used to restrict the wavelength coordinates
of the output spectra.  Specified values apply to all apertures unless
overriden by a wavelength table.  If two or more have the value INDEF
then suitable defaults based on the reference dispersion solution are
used.  These defaults may either come from all spectra or individually
for each spectrum depending on the values of the \fIglobal\fR
parameter.  Also the defaults may be based on each aperture
independently or over the entire wavelength range depending on the
output \fIformat\fR or \fIsamedisp\fR parameter.  The "multispec" and
"onedspec" formats treat each aperture separately unless the
\fIsamedisp\fR is set.  The various combining options base the defaults on the
entire wavelength range and the minimum dispersion.  Note that if a
logarithmic wavelength scale is selected then \fIw1\fR, \fIw2\fR, and
\fIdw\fR must be specified logarithmically.
.le
.ls interpolation = "poly5"
Interpolation type.  The interpolation types are "linear" for linear,
"poly3" for cubic polynomial, "poly5", for quintic polynomial, and
"spline3" for cubic spline.
.le
.ls log = no
Use linear logarithmic wavelength coordinates?  Linear logarithmic
wavelength coordinates have wavelength intervals which are constant
in the logarithm of the wavelength.
.le
.ls flux = yes
Conserve the total flux during interpolation?  If \fIno\fR the output
spectrum is interpolated from the input spectrum at each output
wavelength coordinate.  If \fIyes\fR the input spectrum is integrated
over the extent of each output pixel.  This is slower than
simple interpolation.
.le
.ls samedisp = no
Use the same dispersion parameters for all apertures within a
multispec spectrum? If no then the
dispersion parameters are set independently for each aperture while
if yes then the all the apertures will have the same dispersion.
.le
.ls global = no
Use the same dispersion parameters for the same aperture in all
spectra?  Defaults for the INDEF wavelength coordinate parameters are
determined if two or less of the wavelength parameters are specified
for an aperture.  If this parameter is \fIno\fR this is done
independently for each input spectrum.  If this parameter is \fIyes\fR
then the wavelength ranges and aperture lengths from all the input
spectra for each aperture are used to determine defaults for all the
spectra of the same aperture.  The global option is used to have all
the dispersion corrected spectra for each aperture have the same
wavelength coordinates without actually specifying the wavelength
parameters.  If both \fBsamedisp\fR and \fBglobal\fR are set then all
spectra from all apertures will have the same dispersion parameters.
.le
.ls confirm = no
Confirm the wavelength parameters for each spectrum and aperture?  If
\fIyes\fR the wavelength parameters will be printed and the user will
be asked whether to accept them.  If the parameters are not acceptable
the user will be queried for new values.  The confirmation and
parameter changes are repeated until an acceptable set of parameters is
obtained.  When the \fIsamedisp\fR parameter is set there is only
one confirmation for the entire spectrum otherwise this is done for
each aperture.  When the \fIglobal\fR parameter is \fIyes\fR changes to the
wavelength parameters will remain in effect until changed again. If the
response is \fINO\fR then there will be no further confirmation for
that spectrum or aperture in subsequent spectra.
.le
.ls rebin = no
Rebin previous dispersion corrections?  If not set then spectra which have
been dispersion corrected are ignored.  If set then the spectra which have
not been dispersion corrected are ignored and dispersion corrected spectra
are reinterpolated to new wavelength coordinates.
.le
.ls listonly = no
List the dispersion coordinates only?  If set then the dispersion coordinates
are listed but the spectra are not dispersion corrected.  This may be used
to determine what the default wavelengths would be based on the dispersion
solutions.
.le
.ih
DESCRIPTION
The input multispec format spectra are dispersion corrected to linear
wavelength coordinates (possibly linear in the logarithm of the
wavelength) by interpolation using the dispersion solutions of the
reference spectra specified in the image header.  This may be done
independently for each aperture or the apertures may be combined.
The input spectra must have one
or both of the reference spectra definitions REFSPEC1 and REFSPEC2 in
the image header.  When there are two reference spectra the spectrum
names may be followed by a weighting factor (assumed to be 1 if
missing).  The wavelength of a pixel is then the weighted average of
the wavelengths from the reference spectra dispersion solutions.  The
task \fBrefspectra\fR provides a number of ways to assign reference
spectra.  Note, however, that these assignments may be made directly
using the task \fBhedit\fR or with some other task or script if none of
the methods are suitable.  The reference spectra must have dispersion
solutions in the specified \fIdatabase\fR produced by the task
\fBidentify\fR for each aperture.  (Actually \fBidentify\fR does not
know about the apertures and the assignment of dispersion functions
is done by line number.  Thus, the arc reference apertures must be
in the same order and number as the object spectra.)
 
If the \fIrebin\fR parameter is not set then dispersion corrected
spectra (header flag DC-FLAG is not -1) are skipped.  If it is set then
dispersion corrected spectra are reinterpolated to a new linear
coordinate system from the old linear coordinate system and
non-dispersion corrected spectra are skipped.  Note that the database
dispersion solutions are ignored for rebinning.

The output spectra are specified by a matching list of names, or
root names if using the "onedspec" output format.  If no
output list is given then the input spectrum names are used as
output names thus replacing the spectrum by the dispersion corrected
spectrum.  The input spectrum will also be replaced if the output
name is the same as the input name.
 
There are three types of output spectra formats selected by the
\fIformat\fR parameter.  The "multispec" format is the same as the
input format in which each aperture is a separate line in a two dimensional
image.  The "onedspec" format separates the apertures into individual
images by using the output name as a root and appending the aperture
number as a four digit extension.  This
type of spectrum is the same format commonly used with the \fBonedspec\fR
package.  In both these formats the final dispersion coordinates may
be defined independently for each aperture or all may be given the same
dispersion coordinates.   This is determined by the parameter
\fIsamedisp\fR.  In the multispec format the
size of the output image will be equal to the length of the longest
aperture while in the onedspec format each spectrum may also have an
independent length.
 
The remaining output formats, "sum", "average", and "maximum", combine
the apertures into a single one dimensional spectrum with a single linear
wavelength coordinate system.  Overlapping apertures are combined by
summing, averaging, or taking the maximum value as desired and gaps
between apertures are filled with zero.  When all the apertures are
rebinned to the same dispersion then this can be used to produce the
average or sum directly.
 
The linear wavelength coordinate system(s) are specified by a starting
wavelength, an ending wavelength, a wavelength interval per pixel, and
the number of pixels.  These four parameters actually overspecify the
coordinate system and only three of these values are needed to define
it.  The output coordinate system is specified by giving a set or
subset of these parameters using the parameters \fIw1\fR, \fIw2\fR,
\fIdw\fR, and \fInw\fR.  When the \fIlog\fR option is used these
parameters are interpreted as logarithmic; i.e. the starting value is
the log of the wavelength of the first pixel and the interval is the
interval in the log of the wavelength.  The specified values apply to
all apertures unless overriden by a wavelength table.
 
If two or more have the value INDEF then suitable defaults based on the
reference dispersion solutions are used.  These defaults may either
come from all spectra or individually for each spectrum depending on
the values of the \fIglobal\fR parameter.  Also the defaults may be
based on each aperture independently or over the entire wavelength
range depending on the output \fIformat\fR or \fIsamedisp\fR
parameters.  The "multispec" and "onedspec" formats treat each aperture
separately unless the \fIsamedisp\fR is set.  The various combining
options base the defaults on the entire wavelength range and the
minimum dispersion.
 
Wavelengths for each aperture may be specified independently without resorting
to defaults by using a wavelength table.  This table consists of lines
containing an aperture number,
the starting wavelength, the ending wavelength,
the wavelength interval per pixel, and the number of output pixels.
Any of these values may be specified as INDEF (though usually the aperture
number is not).  The name of the table file is specified by the
parameter \fItable\fR.  One way to view this is that an entry in the
wavelength table overrides the values of the parameters \fIw1\fR,
\fIw2\fR, \fIdw\fR, and \fInw\fR, which normally apply to all apertures,
for the specified aperture.  The wavelength table is used to specify
explicit independent values for apertures.
 
The input spectrum name and the wavelength parameters are printed
on the standard output.  If one wishes to verify and possibly
change the defaults assigned, either globally or
individually, the \fIconfirm\fR flag may be set.  The user
is asked whether to accept these values.  By responding with no
the user is given the chance to change each parameter value.
Then the new parameters are printed and the user is again asked
to confirm the parameters.  This is repeated until the
desired parameters are set.  When the defaults are not global
the changed parameters will not be used for the next spectrum.
When the global option is used any changes made are retained
(either for all apertures or independently for each aperture)
until changed again.
 
When adjusting the wavelengths the user should specify which parameter
is free to change by entering INDEF.  If none of the parameters are
specified as INDEF then those values which were not changed, i.e. by
accepting the current value, are the first to be changed.
 
Once the wavelength scale has been defined the input spectrum is
interpolated for each output pixel.  Output wavelengths outside
the range of the input spectrum are set to zero.  The interpolation
function is selected by the user.  When it is desired to conserve
flux, particularly when the dispersion is significantly reduced,
the output pixel value is obtained by integrating the interpolation
function across the wavelength limits of the output pixel.
 
The wavelength coordinate system is entered in the output spectrum
image header.  For multispec format the APNUMn keywords are used and
the aperture number, aperture number, starting wavelength, wavelength
interval per pixel, and the number of useful pixels are specified as a
string.  The number of pixels may differ from the size of the image
since the size will be adjusted to contain the longest aperture.  For
the one dimensional spectra or if the \fIsamedisp\fR paramter is set
the standard \fBonedspec\fR package keywords are set with the starting
wavelength recorded in the parameters W0 and CRVAL1 and the wavelength
interval per pixel recorded in the parameters WPC and CDELT1.  Also the
parameter CRPIX1 is set to 1; i.e. the pixel to which the value of
CRVAL1 refers is the first pixel.  The dispersion correction flag
DC-FLAG is set to 0 if the coordinates are in linear wavelength and 1
if they are linear in logarithm of the wavelength.
 
If one wishes to only check what wavelengths will be determined for the
defaults without actually dispersion correcting the spectra the
\fIlistonly\fR flag may be set.
.ih
KEYWORDS
The output spectrum is a copy of the input spectrum.  The size of
the output image is modified as may some of the following keywords.
 
.ls APFORMAT
The spectrum format.  This is not used on input and so may be absent.
The output will be either "multispec" or "onedspec".
.le
.ls APNUMn
These keywords must be present.  There is one for
each image line with the line number replacing "n" in the keyword name.
The value is a string consisting of the aperture number set by the
\fBapextract\fR package, the aperture number repeated or the order
number for echelle spectra, the coordinate of the first pixel, the
coordinate interval per pixel, and the number of valid pixels starting
with the first pixel.  Generally the coordinate information will be
pixels initially and wavelength after dispersion correction.
.le
.ls W0, WPC
If a onedspec format spectrum is created or all the apertures have the
same dispersion the starting coordinate and
coordinate interval per pixel is added for these ONEDSPEC keywords.
.le
.ls CRPIX1, CRVAL1, CDELT1
If a onedspec format spectrum is created or all the apertures have the
same dispersion the reference pixel, coordinate
at the reference pixel, and coordinate interval per pixel is added for
these FITS keywords.
.le
.ls DC-FLAG
The DC-FLAG must be -1 for uncorrected spectra and 0 for linearize spectra
or 1 for linearized spectra in the logrithm.  If absent -1 is assumed and
is always set on output.
.le
.ih
EXAMPLES
1.  Dispersion correct a spectrum with 31 apertures with no confirmation using
the default wavelengths for all apertures.
 
.nf
cl> msdispcor f034.ms w034.ms
w034.ms: ap = 1, w1 = 6821.513, w2 = 6917.617, dw = 0.1202804, nw = 800
w034.ms: ap = 2, w1 = 6824.633, w2 = 6920.489, dw = 0.1202681, nw = 800
	...
w034.ms: ap = 30, w1 = 6827.604, w2 = 6935.573, dw = 0.1202561, nw = 800
w034.ms: ap = 31, w1 = 6831.369, w2 = 6938.742, dw = 0.1202346, nw = 800
.fi
 
2.  Dispersion correct a spectrum with 31 apertures with no confirmation to
the same dispersion.
 
.nf
cl> msdispcor f034.ms w034.ms samedisp+ confirm-
w034.ms: w1 = 6821.513, w2 = 6917.617, dw = 0.1202804, nw = 800, log = no
.fi
 
 
3.  Dispersion correct two spectra with confirmation.  Note the behavior of the
responses "yes", "no", and "NO".
 
.nf
cl> msdispcor f034.ms,f039.ms w034.ms,w039.ms confirm+
w034.ms: ap = 1, w1 = 6821.513, w2 = 6917.617, dw = 0.1202804, nw = 800
  Change wavelength coordinate assignments? (yes|no|NO) (no): y
  Starting wavelength (6821.5131835937): 6820
  Ending wavelength (6917.6171875): INDEF
  Wavelength interval per pixel (0.12028035521507): 0.10
  Number of output pixels (800): INDEF
w034.ms: ap = 1, w1 = 6820., w2 = 6917.6, dw = 0.1, nw = 977
  Change wavelength coordinate assignments? (yes|no|NO) (yes): n
w034.ms: ap = 2, w1 = 6824.633, w2 = 6920.489, dw = 0.1202681, nw = 800
  Change wavelength coordinate assignments? (yes|no|NO) (yes): n
w034.ms: ap = 3, w1 = 6825.591, w2 = 6921.472, dw = 0.1202691, nw = 800
  Change wavelength coordinate assignments? (yes|no|NO) (no): N
w034.ms: ap = 4, w1 = 6826.615, w2 = 6922.426, dw = 0.1202666, nw = 800
  Change wavelength coordinate assignments? (yes|no|NO) (NO): 
  ...
w039.ms: ap = 1, w1 = 6821.496, w2 = 6917.632, dw = 0.1203207, nw = 800
  Change wavelength coordinate assignments? (yes|no|NO) (NO):
w039.ms: ap = 2, w1 = 6823.535, w2 = 6919.488, dw = 0.12033, nw = 800
  Change wavelength coordinate assignments? (yes|no|NO) (NO): y
  Starting wavelength (6823.5346679687): 6823
  Ending wavelength (6919.4877929688): INDEF
  Wavelength interval per pixel (0.12032075682001): 0.1
  Number of output pixels (800): INDEF
w039.ms: ap = 2, w1 = 6823., w2 = 6933.5, dw = 0.1, nw = 956
  Change wavelength coordinate assignments? (yes|no|NO) (yes): N
  ...
.fi
 
4. Dispersion correct and combine apertures by averaging.
 
.nf
cl> msdispcor f034.ms w034.ms format="average" dw=0.1 confirm+
w034.ms: w1 = 6823.369, w2 = 6917.369, dw = 0.1, nw = 994, log = no
  Change wavelength coordinate assignments? (yes|no|NO): y
  Starting wavelength (6823.3686523437): 6800
  Ending wavelength (6917.3688476562): 6900
  Wavelength interval per pixel (0.10000000149012): 0.10
  Number of output pixels (994): INDEF
w034.ms: w1 = 6800., w2 = 6900., dw = 0.1, nw = 1001
  Change wavelength coordinate assignments? (yes|no|NO) (yes): n
.fi
.ih
SEE ALSO
refspectra
.endhelp

