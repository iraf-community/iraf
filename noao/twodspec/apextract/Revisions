.help revisions Jun88 noao.twodspec.apextract
.nf
apextract$exsum.x
    There was an incorrect sfree called if output images exist and the user
    does not chose to clobber them (which is also the default for
    noninteractive.  (4/4/90, Valdes)

apextract$exsum.x
    Added a test for the existence of output images before extractions and
    a query to select whether to clobber spectra or not.  (8/9/89, Valdes)

apextract$exmvsum.x
apextract$exfit.x
    1.  The moving average for profile images did not work correctly.  It
	subtracted the line moving out of the moving average but failed to
	add in the line moving into the average.  This caused the profile
	to depart more and more from the data as the extraction procedes
	through the image.
    2.  The moving average for profile images actually used naverage + 1
	instead of naverage becuase in this case the line being extract is
	also included in the average.
    3.  The fitting of the model to the data had a funny behavior when the
	model had negative values and variance weight was used.  The
	negative values are now excluded from the fitting calculation in
	this case.  Note that the model is supposed to not contain negative
	values.  Also note that if variance weighting is not used then the
	negative values are used in straight least-squares fitting.
	(8/8/89, Valdes)

apextract$apicset.x
apextract$apedit.x
apextract$apupdate.x
    The region over which the background fitting is defined has been extended
    to require overlapping the aperture. (7/31/89, Valdes)

apextract$apcolon.x
    Added gdeactivate/greactivate calls when using EPARAM.  (6/14/89, Valdes)

apextract$apextract.x
    If reference apertures are used without change (no recenter, edit, or
    retrace) then the apertures were not written to the database.  This has
    been changed to write (or query if interactive) the apertures if
    dbwrite=yes.  (5/19/89, Valdes)

apextract$exio.h
apextract$exio.x
apextract$exsum.x
    1.  The maximum number of simultaneous extractions was increased from
	20 to 50.
    2.  The amount of buffering used for column access (dispaxis=1) was
	increased from 100K pixels to 1M chars.  (5/12/89, Valdes)

apextract$doc/apsum.hlp
    Added a sentence about the proper alignment of echelle spectra.
    (5/8/89, Valdes)

apextract$t_apscatter.x +
apextract$apscatter.par +
apextract$apscat1.par +
apextract$apscat2.par +
apextract$doc/apscatter.hlp +
apextract$mkpkg
apextract$x_apextract.x
apextract$apextract.cl
apextract$apextract.men
apextract$apextract.hd
imred$echelle/apscatter.par +
imred$echelle/apscat1.par +
imred$echelle/apscat2.par +
imred$echelle/echelle.cl
imred$echelle/echelle.men
    Added a new task, APSCATTER, to fit and subtract scattered light.
    It includes two hidden psets, APSCAT1 and APSCAT2.  (3/3/89, Valdes)

apextract$apnormalize.par
imred$echelle/apnormalize.par
    Input image parameter name needed to be changed from "images" to "input".
    (2/28/89, Valdes)

apextract$exio.x
    Added errchk for imgeti related to getting DISPAXIS keyword which
    might be missing.  (2/28/89, Valdes)

apextract$exsum.x
    Changed usage of CRPIX keyword to real from integer.  (1/25/89, Valdes)

apextract$apgmark.x
    The size of the aperture labels now decreases with increasing number
    of apertures.  (1/24/89, Valdes)

apextract$t_apnorm.x
apextract$apnormalize.par
imred$echelle/apnormalize.par
apextract$doc/apnormalize.hlp
    Changed parameter names "lowreject" to "low_reject" and "highreject"
    to "high_reject" to be consistent with other ICFIT tasks.
    (1/24/89, Valdes)

apextract$aprecenter.x
    The progress information was not using the verbose parameter.
    (1/23/89, Valdes)

apextract$apedit.x
    Fixed bug causing 'i' info to only be visibly momentarily.
    (12/16/88 Valdes)

apextract$t_apnorm.x
    When fitting the normalization spectrum interactively any deleted
    points would be remembered in the following apertures.  Deleted points
    are now cleared after interactive fitting.  (12/15/88 Valdes)

apextract$apedit.x
    Fixed a minor bug in the 's' option (center + wx --> wx) (12/15/88 Valdes)

apextract$*.x
apextract$apio.par
apextract$doc/apio.hlp
    Removed the beep option. (12/8/88 Valdes)

apextract$exgmodaps.x
    The temporary apertures array and number of apertures were not being
    initialized correctly causing a segmentation violation every time
    the program was run. Added an n = 0 statement and initialized all the
    pointers to NULL. (10/13/88 Davis)

apextract$exmvsum.x
    When cleaning and using a moving average the replacement of the bad pixel
    in a data profile back in the moving average was in error leading to 
    bad results and possible memory corruption.  (10/9/88 Valdes)

apextract$exfit.x
apextract$exmvsum.x
    1.  The sigma clipping test now uses the variance relation for testing the
	residuals.
    2.  A bug was causing the length of the profile image to be incorrectly
	referenced leading to an out of bounds error.

apextract$apedit.x
apextract$exapsum.x
    1.  After doing a ":line" new apertures were defined with the old line
	as the aperture center.  This made tracing fail.
	Now after changing the line the default aperture is updated and
	the apeture center is explicitly set every time.
    2.  In a rare circumstance a divide by zero error occured for the fitted
	background.  This is now checked.  (7/19/88 Valdes)

noao$lib/scr/apedit.key
apextract$apedit.x
    1.  Deleted a reference to :nfind in the cursor help.
    2.  After deleting a background defintion it was no longer possible
	to define a new one.  Now an attempt to define backgrounds
        after they have been deleted is initialized to the default again.
        (7/1/88 Valdes)

apextract$exsum.x
    Fixed a bug in blocking overwriting of existing echelle format spectra.
    Fixed a minor bug in writing the aperture info to the header of a 1D
    format sky spectrum.  (6/16/88 Valdes)

apextract$apgmark.x
    Labels are not written outside of graph range.  (5/20/88 Valdes)

apextract$apedit.x
apextract$exgraph.x
noao$lib/scr/apedit.key
    Added 'I' interrupt.  (4/20/88 Valdes)

apextract$exio.x
    EX_UNMAP when using column access was free a buffer supplied by
    IMIO causing a memory corruption error on VMS.  (3/30/88)

apextract$exgmodaps.x
    Model apertures where not being match up correctly resulting in a
    warning message.  (3/22/88 Valdes)

apextract$exsum.x
apextract$exstrip.x
apextract$exrecen.x
    Added iferr statements for asifit.  Without this the task crashed
    when an aperture went off the edge.  (3/10/88 Valdes)

apextract$* Major changes:
	o Use profile template image
	o Don't interpolate data profile before cleaning
	o New background option
	o Integrate apertures
	o Restructure code
	o And much more
    (3/1/88 Valdes)

==============
APEXTRACT V2.0
==============

apextract$excextract.x -
apextract$exlextract.x -
    Removed these unused procedures. (1/5/88 Valdes)

apextract$excstrip.x
apextract$exlstrip.x
    Free curfit pointer if ic_fit returns an error. (1/5/88 Valdes)

apextract$excsum.x
apextract$exlsum.x
    Set background to zero if ic_fit returns an error. (1/5/88 Valdes)

    Original:
	iferr (call ic_fit (AP_IC(aps[i]), cv, Memr[x],
	    Memr[bufin], Memr[w], ncols, YES, YES, YES, YES))
	    ;

    New:
	iferr {
	    call ic_fit (AP_IC(aps[i]), cv, Memr[x],
	        Memr[bufin], Memr[w], ncols, YES, YES, YES, YES)
	    call ex_apbkg (cv, ncols, center, low, high,
	        skyout[line,i])
	} then
	    skyout[line,i] = 0.

apextract$exapsum.x
    Added check for no data in sum. (1/5/88 Valdes)

    In procedure ex_apsum:
	a = max (0.5, center + lower)
	b = min (npts + 0.5, center + upper)

	if (a >= b) {			<-- ADD
	    sum = 0.			<-- ADD
	    return			<-- ADD
	}

    In procedure ex_apbkg:
	a = max (0.5, center + lower)
	b = min (npts + 0.5, center + upper)

	if (a >= b) {			<-- ADD
	    bkg = 0.			<-- ADD
	    return			<-- ADD
	}

apextract$apnormalize.x
    There was no error checking on ap_dbread which caused misleading errors
    (apio package not found).  This was fixed by updating the logic to be the
    same as in apextract.x.  A quick fix for outside sites is to add an
    errchk for ap_dbread.  (12/18/87 Valdes)

apextract$apedit.x
apextract$apgscur.x
    When first entering APEDIT with apertures defined the first attempt to
    point the cursur at the first aperture uses an indefinite y value since
    no cursor read has yet taken place.  The choices are to set it to some
    arbitrary value, some percentage level on screen, or do nothing.  I
    chose to do nothing.  Thus, the cursor will not point at the current
    aperture in this case but it will leave the cursor position unchanged.
    (12/17/87 Valdes)

apextract$apio.par
apextract$exsum.x
apextract$exoutsum.x
apextract$apedit.x
    Added new parameter "format" to APIO pset.  Added new output formats for
    echelle and multispectra data consisting of a single 2D image.  Added new
    information in header.  Old format is called "onedspec".

    Removed debugging print statement.  When it was put in I don't know.
    (12/17/87 Valdes)

apextract$apextract.x
    An error was introduced with the change of 11/9/87 such that the error
    when a database file does not exists was no longer being trapped.  This
    was intended for reference images but was not intended for creating new
    database files.  An iferr was added.

apextract$t_apnormalize.x
apextract$trtrace.x
apextract$exstrip.x
apextract$exsum.x
    ERRCHK declarations for IMGETI were added to detect a missing DISPAXIS.
    Failing to catch this error caused misleading error messages and
    other fatal errors. (11/9/87 Valdes)

apextract$apextract.x
apextract$apdb.x
    An error reading apertures for a specified reference image is now
    printed instead of assuming there are no reference apertures.
    (11/9/87 Valdes)

apextract$exfit.x
    Changed the variance formula from
	V = v0 + v1 * abs (S + B)
    to
	V = v0 + v1 * max (0, S + B)		if v0 > 0
	V = v1 * max (1, S + B)			if v0 = 0
    (11/9/87 Valdes; see also 8/6/87)

apextract$t_apnormalize.x
    When normalizing more than 20 apertures some of the apertures
    were being lost in the output image.  This was fixed to only
    fill between the apertures on the first set of apertures.

    Normalizing when DISPAXIS=1 did not work.  There were a number of
    errors.  This task was never tested with data in this orientation.
    (9/22/87 Valdes)

apextract$exfit.x
apextract$apsum.par
apextract$apstrip.par
apextract$doc/apsum.hlp
apextract$doc/apstrip.hlp
    When computing the variance for doing variance weighting the
    intensity could be negative.  An absolute value was added to
    correct this.

    Make defaults for naverage=100 and nclean=2 because people have
    been using inadequate number of lines for low signal-to-noise
    data and because of interpolation even an 1 pixel cosmic ray
    expands to two pixels.  (8/6/87 Valdes)

====
V2.5
====

apextract$apio.par
apextract$apio.x
apextract$t_apnormalize.x
apextract$exsum.x
apextract$exstrip.x
apextract$apfindnew.x
apextract$apfind.x
apextract$apextract.x
apextract$apedit.x
apextract$trtrace.x
apextract$trltrace.x
apextract$trctrace.x
apextract$exgraph.x
apextract$doc/apio.hlp
    Valdes, May 19, 1987
    1.  Added the parameter "verbose" to the APIO pset to allow turning off
	log information to the terminal.
    2.  Made changes to minimize switching between text and graphics mode.
	With verbose=no there should be essentially no mode switching.  This
	was done for terminals in which such switches is either annoying
	or slow.

apextract$mkpkg
apextract$apcvset.x
apextract$t_apnormalize.x
apextract$trtrace.x
apextract$exsum.x
apextract$exstrip.x
apextract$apgetdata.x
apextract$apimmap.x +
    Valdes, April 24, 1987
    1.  Protection against using an image which is not 2 dimensional was added.

apextract$apedit.x
apextract$apextract.x
apextract$apsum.par
apextract$exapsum.x
apextract$excsum.x
apextract$exgprofs.x
apextract$exlsum.x
apextract$exoutsum.x
apextract$exsum.x
apextract$doc/apsum.hlp
    Valdes, April 11, 1987
    1.  Added additional option to APSUM to output the subtracted sky
	background spectra when doing background subtraction.

apextract$apextract.hd
apextract$apextract.men
apextract$apextract.par
apextract$apgetim.x
apextract$apnormalize.par
apextract$mkpkg
apextract$t_apnormalize.x +
apextract$x_apextract.x
apextract$doc/apnormalize.hlp +
    Valdes, April 3, 1987
    1.  New task APNORMALIZE installed.

apextract$*x
    Valdes, February 17, 1987
    1.  Required GIO changes.

apextract$apio.h
apextract$exgraph.x
apextract$apio.x
apextract$excextract.x
apextract$apextract.tar
apextract$trltrace.x
apextract$trctrace.x
apextract$exlextract.x
apextract$applot.x
apextract$apedit.x
    Valdes, February 13, 1987
    1.	I've made a number of modifications to the APEXTRACT package to
	correct problems in the way graphics and text are mixed.  The
	main change was to make the graphics open very local to the
	procedure doing the graphics.  Previously the graphics device
	was opened at the beginning of the logical task and remained
	open until the end.  This was done since the integrated nature
	of the package has many procedures which may do graphics.  This
	has the bad side effects that for the first graphics open of
	the process the terminal enters graphics mode (graphics screen
	on SUN and clear screen on VT640) well before any graphics is
	performed and text I/O is a problem.  Putting GOPEN and GCLOSE
	immediately around the code that does graphics fixed almost all
	the problems.  The only time that text output is now done when
	the graphics terminal is open is for '?' and ':show' type of
	commands.  The only remaining problem is the page wait problem
	associated with '?' occuring before a cursor read rather than
	immediately after the text output causing the last written
	status line to become confused with the page wait prompt.

apextract$apfind.par
    Valdes, February 12, 1987
    1.  The parameter apfind.nfind was changed back to hidden in order
	for apsum to work in the background.  Note the PSET mechanism
	would fix this by allowing nfind to be specified on the command
	line.

apextract$apio.par
    Valdes, February 9, 1987
    1.  New users rarely look at or know about the log files produced by
	the package tasks.  These files (particularly graphics) take up
	a lot of space.  Therefore the default is now not to log
	text or graphics output.

apextract$apedit.x
apextract$apsort.x
apextract$exapsum.x
apextract$trltrace.x
apextract$trctrace.x
apextract$doc/apedit.hlp
noao$lib/scr/apedit.key
    Valdes, February 2, 1987
    1.  Added a new edit option, 'o', to reorder the aperture id and beam
	numbers sequentially.  This is useful after apertures have been
	deleted and added interactively.
    2.  If the aperture went completely off the image (ie there is no
	overlap of even part of the aperture with the image) a random value
	was given the aperture sum because the value was not intialize to
	zero.  It is now initialize to zero.
    3.  There is now a requirement that more than three points be traced
	before a trace will be fit.

apextract$trltrace.x
apextract$trctrace.x
apextract$apgetdata.x
    Valdes, January 30, 1987
    1.  The middle line (default) was not calculated correctly.  
    2.  The tracing would sometimes run beyond the end of the image.  The
	value of this traced point is suspect.  It was found because there
	would be a point off the end of the ICFIT graph which was set to
	be the size of the image.
    3.  Just in case a traced point is right at the edge I made the default
	window for fitting the trace extend half a step beyond the edges
	of the image.

apextract$exsum.x
apextract$exstrip.x
    Valdes, January 30, 1987
    1.  Skip Schaller (Steward) reported a problem with running out of memory
	with an input list of 20 images.  Also when the user deleted input
	images after they were processed but before the list was finished
	(to reduce memory) the memory was not actually freed until the process
	actually finished.  I found that the input images
	where not being closed! (Sorry about this really stupid error.)
	This may not be all the problem but it is probable since IMIO
	maintains large buffers.

apextract$apcolon.x
    Valdes, January 15, 1987
    1.  Replaced dictionary string and numeric case by macros for readability.

apextract$apfind.par
    Valdes, December 19, 1986
    1.  Change the default NFIND parameter in APFIND to auto mode.

apextract$apnearest.x
    Valdes, December 12, 1986
    1.  It is possible for more than one aperture to be equidistant from
	the cursor, particularly when more than one aperture is defined for
	the same feature.  This is ambiguous for those commands which operate on
	the nearest aperture.  The modification will query the user if it
	is found that there is more than one aperture at the same distance
	from the cursor.

apextract$peaks.x
    Valdes, October 10, 1986
    1.  VMS adjustable array dimension error found.  Replaced declaration
	dimension by ARB since the passed dimension value may be zero.

apextract$*
    Valdes, September 16, 1986
    1.  A new version of the package has been installed.  It is very
	different from the old version.  The user parameter files must
	be unlearned.

====================
New Package Released
====================

apextract$: Valdes, July 19, 1986
    1.  APEDIT and TRACE modified to include a detection threshold parameter
	for profile centering.
    2.  The help pages were updated.

apextract$apedit.x, apvalue.x: Valdes, July 17, 1986
    1.  A bug was found that appears if you edit the apertures of a
	previously traced image.  The center moves with use of 'l' or
	'u'.  This is due to an inconsistency between whether the aperture
	center is before or after the traced shift is added.  Changes
	to APVALUE.X and the calls to it in APEDIT.X fix this.

apextract$: Valdes, July 15, 1986
    1.  TRACE had a bug when trying to specify an explicit starting
	line to edit and trace from.  This was fixed.
    2.  EXCEXTRACT.X, EXLEXTRACT.X, and EXGPROFS.X were modified to
	check for errors from background fitting.  This arose when
	trying to get the background for a spectrum which has gone
	off the edge of the image.

apextract$apedit.x, apsort.x : Valdes, July 9, 1986
    1.  When changing the aperture number the apertures are sorted and
	then the wrong aperture could become the current aperture if
	another aperture exists with the same aperture number.  This was
	fixed so that the sorting returns the correct current aperture
	after sorting.  Also apindex.x is no longer needed.

apextract$apedit.x: Valdes, July 7, 1986
    1.  The 'd' delete key now does nothing if no apertures are defined.
	Previously it would cause a failure of the task.

apextract$apedit.x:  Valdes, July 7, 1986
    1.  Added redraw and window commands.
    2.  Help page and '?' menu updated.

apextract$apedit.x:  Valdes, July 3, 1986
    1.  APEDIT modified to use new ICFIT package.

apextract$apgetim.x:  Valdes, July 1, 1986
    1.  New procedure to strip the image extension.  This is necessary
	to create proper database files and to avoid having two legal
	names for images in the database.

apextract$exapstrip.x:  Valdes, July 1, 1986
    1.  Simple strip extraction without profile modeling interpolated
	the data so that the lower edge of the aperture was centered
	on the first pixel.  This is inconsistent with the other extractions
	which put the center of the aperture at the center of a pixel.
	This has been fixed.

apextract:  Valdes, June 30, 1986:
    1.  TRACE was not correctly initializing the new ICFIT package.
	In particular the task parameters "function" and "order" had no
	effect and when multiple files were used the last set parameters
	were not retained.  Changes to t_trace.x, trctrace.x, trltrace.x.

=====================================
STScI Pre-release and SUN 2.3 Release
=====================================

apextract:  Valdes, June 20, 1986:
    1.  New APEXTRACT installed.  This version includes background
	subtraction and new ICFIT.

apextract:  Valdes, June 2, 1986
    1.  Another round of name changes.  EDITAPS -> APEDIT,
	EXTRACT1 -> SUMEXTRACT, EXTRACT2 -> STRIPEXTRACT.

apextract:  Valdes, May 16, 1986
    1.  Renamed APDEFINE to EDITAPS.
    2.  Moved parameters used in editing the apertures from EXTRACT1 and
	EXTRACT2.  These are now obtained from EDITAPS regardless of which
	task calls apedit.
    3.  Added parameters "cradius", "cwidth", "ctype", "lower", and "upper"
	to EDITAPS.  The first parameters control profile centering and the
	last parameters set the default aperture limits.
    1.  Added new keys.  'c' center current aperture of profile near the cursor.
	'm' mark and center aperture on profile near the cursor.  's' shift
	the center of the current aperture to the cursor position.  The change
	allows centering of profiles using CENTER1D.

apextract$extract.x:  Valdes, May 13, 1986
    1.  EXTRACT has been broken up into two tasks; EXTRACT1 and EXTRACT2.
	EXTRACT1 extracts weighted summed 1D spectra.  EXTRACT2 extracts
	2D apertures corrected for shifts across the dispersion.

apextract:  Valdes, April 23, 1986
    1.  Modified EXTRACT to only warn about an existing output image.
	This allows adding a new aperture without needing to delete
	old apertures or reextract previous extractions.

apextract:  Valdes, April 21, 1986
    1.  All procedures which pass the number of current apertures as an
	argument and then dimension the array with this number
	were modified by dimensioning the array as dimension
	APS_MAXAPS or ARB.  This was done because the number of apertures
	might be zero.  This is a fatal error on VMS/VAX though not on UNIX/VAX.

apextract:  Valdes, March 27, 1986
    1.  Modified EXTRACT (exsum.x and exwt.x) to update the dispersion image
	header parameters.  In particular if the input dispersion axis is 2
	then the header parameters must be reset to dispersion axis 1.

===========
Release 2.2
===========
.endhelp
