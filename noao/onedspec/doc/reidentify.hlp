.help reidentify Mar92 noao.onedspec
.ih
NAME
reidentify -- Reidentify features
.ih
USAGE
reidentify reference images
.ih
PARAMETERS
.ls reference
Image with previously identified features to be used as features reference for
other images.  If there are multiple apertures, lines, or columns in the
image a master reference is defined by the \fIsection\fR parameter.
The other apertures in multispec images or other lines, or columns
(selected by \fIstep\fR) are reidentified as needed.
.le
.ls images
List of images in which the features in the reference image are to be
reidentified.  In two and three dimensional images the reidentifications are
done by matching apertures, lines, columns, or bands with those in the reference
image.
.le
.ls interactive = no
Examine and fit features interactively?  If the task is run interactively a
query (which may be turned off during execution) will be given for each
vector reidentified after printing the results of the automatic fit and the
user may chose to enter the interactive \fBidentify\fR task.
.le
.ls section = "middle line"
If the reference image is not one dimensional or given as a one dimensional
image section then this parameter selects the master reference image
vector.  The master reference is used when reidentifying other vectors in
the reference image or when other images contain apertures not present in
the reference image.  This parameter also defines the direction
(columns, lines, or z) of the image vectors to be reidentified.

The section parameter may be specified directly as an image section or
in one of the following forms

.nf
line|column|x|y|z first|middle|last|# [first|middle|last|#]]
first|middle|last|# [first|middle|last|#] line|column|x|y|z
.fi

where each field can be one of the strings separated by | except for #
which is an integer number.  The field in [] is a second designator which
is used with 3D data.  See the example section for \fBidentify\fR for
examples of this syntax.  Abbreviations are allowed though beware that 'l'
is not a sufficient abbreviation.
.le
.ls newaps = yes
Reidentify new apertures in the images which are not in the reference
image?  If no, only apertures found in the reference image will be
reidentified in the other images.  If yes, the master reference spectrum
is used to reidentify features in the new aperture and then the
new aperture solution will be added to the reference apertures.  All
further identifications of the new aperture will then use this solution.
.le
.ls override = no
Override previous solutions?  If there are previous solutions for a
particular image vector being identified, because of a previous
\fBidentify\fR or \fBreidentify\fR, this parameter selects whether
to simply skip the reidentification or do a reidentification and
overwrite the solution in the database.
.le
.ls refit = yes
Refit the coordinate function?  If yes and there is more than one feature
and a coordinate function was defined in the reference image database then a new
coordinate function of the same type as in the reference is fit
using the new pixel positions.  Otherwise only a zero point shift is
determined for the revised coordinates without changing the
form of the coordinate function.
.le

The following parameters are used for selecting and reidentifying additional
lines, columns, or apertures in two dimensional formats.
.ls trace = no
There are two methods for defining additional reference lines, columns, or
bands in two and three dimensional format images as selected by the
\fIstep\fR parameter.  When \fItrace\fR is no the master reference line or
column is used for each new reference vector.  When this parameter is yes
then as the reidentifications step across the image the last reidentified
features are used as the reference.  This "tracing" is useful if there is a
coherent shift in the features such as with long slit spectra.  However,
any features lost during the tracing will be lost for all subsequent lines
or columns while not using tracing always starts with the initial set of
reference features.
.le
.ls step = "10"
The step from the reference line, column, or band used for selecting and/or
reidentifying additional lines, columns, or bands in a two or three
dimensional reference image.  For three dimensional images there may be two
numbers to allow independent steps along different axes.  If the step is
zero then only the reference aperture, line, column, or band is used.  For
multiaperture images if the step is zero then only the requested aperture
is reidentified and if it is non-zero (the value does not matter) then all
spectra are reidentified.  For long slit or Fabry-Perot images the step is
used to sample the image and the step should be large enough to map any
significant changes in the feature positions.
.le
.ls nsum = "10"
Number of lines, columns, or bands across the designated vector axis to be
summed when the image is a two or three dimensional spatial spectrum.
It does not apply to multispec format spectra.  If the image is three
dimensional an optional second number can be specified for the higher
dimensional axis  (the first number applies to the lower axis number and
the second to the higher axis number).  If a second number is not specified
the first number is used for both axes.  This parameter is not used for
multispec type images.
.le
.ls shift = "0"
Shift in user coordinates to be added to the reference features before
centering when stepping to other lines, columns, or bands in the reference
image.  Generally no shift is used by setting the value to zero.
The shift is used as a slope with positive values increasing towards
larger line or column numbers.  This parameter is not used for
reidentifications from the reference image to other images.
If the image is three dimensional then two numbers may be specified
for the two axes.
.le
.ls nlost = 0
When reidentifying features by tracing, if the number of features not found
in the new image vector exceeds this number then the reidentification
record is not written to the database and the trace is terminated.  A
warning is printed in the log and in the verbose output.
.le

The following parameters define the finding and recentering of features.
See also \fBcenter1d\fR.
.ls cradius = 5.
Centering radius in pixels.  If a reidentified feature falls further
than this distance from the previous line or column when tracing or
from the reference feature position when reidentifying a new image
then the feature is not reidentified.
.le
.ls threshold = 10.
In order for a feature center to be determined, the range of pixel
intensities around the feature must exceed this threshold.  This parameter
is used to exclude noise peaks and terminate tracing when the signal
disappears.  However, failure to properly set this parameter, particularly
when the data values are very small due to normalization or flux
calibration, is a common error leading to failure of the task.
.le

The following parameters select and control the automatic addition of
new features during reidentification.
.ls addfeatures = no
Add new features from a line list during each reidentification?  If
yes then the following parameters are used.  This function can be used
to compensate for lost features from the reference solution, particularly
when tracing.  Care should be exercised that misidentified features
are not introduced.
.le
.ls coordlist = "linelists$idhenear.dat"
User coordinate list consisting of an ordered list of line coordinates.
Some standard line lists are available in the directory "linelists$":

.nf
	cl> dir linelists
	cl> page linelists$README
.fi
.le
.ls match = 10.
The maximum difference for a match between the feature coordinate function
value and a coordinate in the coordinate list.  The unit of this parameter
is that of the user coordinates.
.le
.ls maxfeatures = 50
Maximum number of the strongest features to be selected automatically from
the coordinate list.
.le
.ls minsep = 2.
The minimum separation, in pixels, allowed between feature positions
when defining a new feature.
.le

The following parameters determine the input and output of the task.
.ls database = "database"
Database containing the feature data for the reference image and in which
the features for the reidentified images are recorded.
.le
.ls logfiles = "logfile"
List of file in which to keep a processing log.  If a null file, "",
is given then no log is kept.
.le
.ls plotfile = ""
Optional file to contain metacode plots of the residuals.
.le
.ls verbose = no
Print reidentification information on the standard output?
.le
.ls graphics = "stdgraph"
Graphics device.  The default is the standard graphics device which is
generally a graphics terminal.
.le
.ls cursor = ""
Cursor input file.  If a cursor file is not given then the standard graphics
cursor is read.
.le
.ih
DESCRIPTION
Features identified in vectors from a reference image are reidentified in
other images and the results recorded in the database.  If the images are
two or three dimensional or multiaperture format and a \fIstep\fR greater
than zero is specified then additional vectors (lines/columns/bands) in the
reference image will be reidentified from the initial master reference
vector (as defined by an image section or \fIsection\fR parameter) provided
they have not been reidentified previously or the \fIoverride\fR flag is
set.  For multiple aperture spectra images, called multiaperture, a step
size of zero means don't reidentify any other aperture and any other step
size reidentifies all apertures.  For two and three dimensional images,
such as long slit and Fabry-Perot spectra, the step(s) should be large
enough to minimize execution time and storage requirements but small enough
to follow shifts in the features (see the discussion below on tracing).
The set of reference identifications is applied to other images in the same
lines, columns, bands, or apertures.  In multiaperture images the same
apertures are matched in the reference image regardless of actual line
order; i.e.  the apertures need not be in the same order or even have all
apertures present.

The reidentification of other features in other reference image vectors
may be done in two ways selected by the parameter \fItrace\fR.  If not
tracing, the initial reference vector is applied to the other selected
vectors.  If tracing, the reidentifications are made with respect to the
last set of identifications as successive steps away from the reference
vector are made.  The tracing method is appropriate for two and three
dimensional spatial images, such as long slit and Fabry-Perot spectra, in
which the positions of features traced vary smoothly.  This allows
following large displacements from the initial reference by using suitably
small steps.  It has the disadvantage that features lost during the
reidentifications will not propagate (unless the \fIaddfeatures\fR option
is used).  By not tracing, the original set of features is used for every
other vector in the reference image.

When reidentifying other vectors in the reference image the parameter
\fBshift\fR may be used to add a shift(s) to the features positions
before recentering.  The shift is added to lines, columns, or bands, greater
than the current line, column, or band and subtracted if less.  If tracing
the shifts are the same from step to step while if not tracing the
shifts are added to the shifts from the previous step.  Thus, in both
cases an approximation of a slope is used.  This allows large
slopes in the features to be followed even when not tracing but the 
shift value must be predetermined.

When tracing, the parameter \fInlost\fR is used to terminate the
tracing whenever this number of features has been lost.  This parameter,
in conjunction with the other centering parameters which define
when a feature is not found, may be useful for tracing features
which disappear before reaching the limits of the image.

When reidentifying features in other images, the reference
features are those from the same aperture, line, column, or band of the
reference image.  However, if the \fInewaps\fR parameter is set
apertures in multiaperture spectra which are not in the reference
image may be reidentified against the master reference aperture and
added to the list of aperture to be reidentified in other images.
This is useful when specta with different aperture numbers are
stored as one dimensional images.

The centering algorithm is described under the topic \fIcenter1d\fR and
also in \fBidentify\fR.  If a feature positions shifts by more than the
amount set by the parameter \fIcradius\fR from the starting position
(possibly after adding a shift) or the feature strength (peak to valley) is
less than the detection \fIthreshold\fR then the new feature is discarded.
The \fIcradius\fR parameter should be set large enough to find the correct
peak in the presence of any shifts but small enough to minimize incorrect
identifications.  The \fIthreshold\fR parameter is used to eliminate
identifications with noise.  Failure to set this parameter properly for the
data (say if data values are very small due to a calibration or
normalization operation) is the most common source of problems in using
this task.

In two and three dimensional images, though not multiaperture images, the
number of lines, columns, or bands given by the parameter \fInsum\fR are summed
to form the one dimensional image vector in which the features are
identified.  This increases the accuracy for reidentifying weak
features.

If a fitting function is defined for the features in the reference image,
say a dispersion function in arc lamp spectra, then the function is refit
at each reidentified line or column if the parameter \fIrefit\fR is yes.
If refitting is not selected then a zero point shift in the user
coordinates is determined without changing the form of the fitting
function.  The latter may be desirable for tracking detector shifts through
a sequence of observation using low quality calibration spectra.  When
refitting, the fitting parameters from the reference are used including
iterative rejection parameters to eliminate misidentifications.

If the parameter \fIaddfeatures\fR is set additional features may be
added after the initial reidentification and function fit using a
line list.  A maximum number of added features, a matching distance
in user coordinates, and a minimum separation from other features
are additional parameters.  This option is similar to that available
in \fBidentify\fR and is described more fully in the help for that task.

A statistics line is generated for each reidentified vector.  The line
contains the name of the image being reidentified (which for two
dimensional images includes the image section and for multiaperture
spectra includes the aperture number), the number of features found
relative to the number of features in the reference, the number of
features used in the function fit relative to the number found,  the
mean pixel, user coordinate, and fractional user coordinate shifts
relative to the reference coordinates, and the RMS relative to the
final coordinate system (whether refit or simply shifted) excluding any
iteratively rejected features from the calculation.

If the task is run with the \fIinteractive\fR flag the statistics line
is printed to the standard output (the terminal) and a query is
made whether to examine and/or refit the features.  A response
of yes or YES will put the user in the interactive graphical mode
of \fBidentify\fR.  See the description of this task for more
information.  The idea is that one can monitor the statistics information,
particularly the RMS if refitting, and select only those which may be
questionable to examine interactively.  A response of no or NO will
continue on to the next reidentification.  The capitalized responses
turn off the query and act as permanent response for all other
reidentifications.

This statistics line, including headers, is written to any specified
log files.  The log information includes the image being
reidentified and the reference image, and the initial shift.

If an accessible file name is given for the plot file then a residual plot
of the reidentified lines is recorded in this file.  The plot file can
be viewed with \fBgkimosaic, stdgraph\fR or reading the file
with ".read" when in cursor mode (for example with "=gcur").
.ih
EXAMPLES
1.  Arc lines and a dispersion solution were defined for the middle
aperture in the multispec for arc spectrum a042.ms.  To reidentify the
other apertures in the reference image and then another arc image:

.nf
  cl> reiden a042.ms a045.ms inter+ step=1 ver+
  REIDENTIFY: NOAO/IRAF V2.9 valdes@puppis Fri 29-Jun-90
    Reference image = a042.ms.imh, New image = a042.ms, Refit = yes
     Image Data    Found     Fit Pix Shift  User Shift     RMS
  a042.ms - Ap 24  48/48   47/48   -2.38E-4    -3.75E-6  0.699
  Fit dispersion function interactively? (no|yes|NO|YES) (yes): y
  a042.ms - Ap 24  48/48   47/48   -2.38E-4    -3.75E-6  0.699
  a042.ms - Ap 23  48/48   47/48      0.216        1.32  0.754
  Fit dispersion function interactively? (no|yes|NO|YES) (yes): n
  a042.ms - Ap 22  48/48   47/48     0.0627       0.383  0.749
  Fit dispersion function interactively? (no|yes|NO|YES) (yes): n
  a042.ms - Ap 21  48/48   47/48      0.337        2.06  0.815
  <etc>
    Reference image = a042.ms.imh, New image = a045.ms, Refit = yes
     Image Data    Found     Fit Pix Shift  User Shift     RMS
  a045.ms - Ap 24  48/48   47/48   -2.38E-4    -3.75E-6  0.699
  Fit dispersion function interactively? (no|yes|NO|YES) (yes): y
  a045.ms - Ap 24  48/48   47/48   -2.38E-4    -3.75E-6  0.699
  a045.ms - Ap 23  48/48   47/48      0.216        1.32  0.754
  Fit dispersion function interactively? (no|yes|NO|YES) (yes): N
  a045.ms - Ap 22  48/48   47/48     0.0627       0.383  0.749
  a042.ms - Ap 21  48/48   47/48      0.337        2.06  0.815
  a042.ms - Ap 20  48/48   47/48     -0.293       -1.79  0.726
  a042.ms - Ap 19  48/48   48/48      0.472        2.88  0.912
.fi

This example is verbose and includes interactive review of reidentifications.
The statistics lines have been shortened.

2.  To trace a stellar profile and arc lines in long slit images for the
purpose of making a distortion correction:

.nf
  cl> reiden rog022[135,*] "" trace+
  cl> reiden rog023 "" sec="mid line" trace+
.fi
.ih
REVISIONS
.ls REIDENTIFY V2.10.3
The section, nsum, step, and shift parameter syntax was extended to apply to 3D
images.  The previous values and defaults may still be used.

For multiaperture data a step of zero selects only the reference aperture
to be reidentified and any other step selects reidentifying all apertures.
.le
.ls REIDENTIFY V2.10
This task is a new version with many new features.  The new features
include an interactive options for reviewing identifications, iterative
rejection of features during fitting, automatic addition of new features
from a line list, and the choice of tracing or using a single master
reference when reidentifying features in other vectors of a reference
spectrum.  Reidentifications from a reference image to another image is
done by matching apertures rather than tracing.  New apertures not present
in the reference image may be added.
.le
.ih
SEE ALSO
center1d, identify
.endhelp
