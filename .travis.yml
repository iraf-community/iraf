matrix:
  include:
    - os: linux
      dist: trusty
      env: IRAFARCH=linux64 OS_VERS=trusty
    - os: linux
      dist: precise
      env: IRAFARCH=linux64 OS_VERS=precise
    - os: linux
      dist: trusty
      env: IRAFARCH=linux OS_VERS=trusty
      addons:
        apt:
          packages:
            - gcc-multilib
            - libcurl4-openssl-dev:i386
            - libncurses5-dev:i386
            - libexpat1-dev:i386
    - os: linux
      dist: precise
      env: IRAFARCH=linux OS_VERS=precise
      addons:
        apt:
          packages:
            - gcc-multilib
            - libcurl4-openssl-dev:i386
            - libncurses5-dev:i386
            - libexpat1-dev:i386
    - os: osx
      osx_image: xcode9.1
      env: IRAFARCH=macintel OS_VERS=sierra
    - os: osx
      osx_image: xcode6.4
      env: IRAFARCH=macintel OS_VERS=yosemite
    - os: osx
      osx_image: xcode9.1
      env: IRAFARCH=macosx OS_VERS=sierra
    - os: osx
      osx_image: xcode7.3
      env: IRAFARCH=macosx OS_VERS=elcapitan

language: c

git:
  depth: 3

before_script:
  - build_tmp=`mktemp -d -t irafbuild.XXXXXXXXX`
  - if [ $IRAFARCH = linux64 ]; then DARCH=lnux.x86_64 ; fi
  - if [ $IRAFARCH = linux ]; then DARCH=lnux.x86 ; fi
  - if [ $IRAFARCH = macintel ]; then DARCH=macx.x86_64 ; fi
  - if [ $IRAFARCH = macosx ]; then DARCH=macx.x86 ; fi
  - URL=http://iraf.noao.edu/iraf/ftp/iraf/v216/PCIX/iraf.$DARCH.tar.gz
  - curl $URL | tar xz
  - ./install -v --term xterm --bindir $build_tmp/bin --cache $build_tmp/cache --imdir $build_tmp/imdir --root `pwd` < /dev/null || true
  - for d in . unix vo noao ; do rm -f $d/bin ;  ln -s bin.${IRAFARCH} $d/bin; done

script:
  - export iraf=$(pwd)/
  - export host=$(pwd)/unix/
  - export tmp=/tmp/
  - if [ $IRAFARCH = linux ]; then ulimit -s unlimited ; fi
  - ./test/run_tests
